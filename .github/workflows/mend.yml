name: Mend CLI Scan

on:
  push:
    branches: [ main ]

jobs:
  mend_scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up environment variables
        env:
          MEND_EMAIL: ${{ secrets.MEND_EMAIL }}
          MEND_USER_KEY: ${{ secrets.MEND_USER_KEY }}
          MEND_URL: https://saas.whitesourcesoftware.com
        run: echo "Environment variables set"

      - name: Download Mend CLI
        run: |
          echo "Downloading Mend CLI"
          curl -sSL https://downloads.mend.io/cli/linux_amd64/mend -o /usr/local/bin/mend
          chmod +x /usr/local/bin/mend

      - name: Run Mend dependencies scan
        run: mend dep -u --format sarif --filename mend-dep-results.sarif

      - name: Run Mend code scan
        run: mend code --format sarif --filename mend-code-results.sarif

      # - name: Run Mend image scan
      #   env:
      #     DOCKER_REPO_NAME: your-docker-repo
      #     DOCKER_TAG: your-docker-tag
      #   run: mend image $DOCKER_REPO_NAME:$DOCKER_TAG --format sarif --filename mend-image-results.sarif --local-pull

      - name: Upload SARIF results for dependency scan
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: mend-dep-results.sarif

      - name: Upload SARIF results for code scan
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: mend-code-results.sarif

      # - name: Upload SARIF results for image scan
      #   uses: github/codeql-action/upload-sarif@v3
      #   with:
      #     sarif_file: mend-image-results.sarif
